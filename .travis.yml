# This script is used by the Travis-CI (continuous integration) testing
# framework to run Simbody's tests with every GitHub push or pull-request.
language: cpp

  
# These are the different builds we want to run.   
matrix:
  include:
    - os: linux
      compiler: gcc
      env: MPI=false # causes this environment variable to be defined.
    - os: linux
      compiler: clang
      env: MPI=false
    - os: linux
      compiler: clang
      env: MPI=true
    - os: osx
      compiler: clang
      env: MPI=false

before_install:
  ## Ensure that there are no tabs in source code.
  # GREP returns 0 (true) if there are any matches, and
  # we don't want any matches. If there are matches,
  # print a helpful message, and make the test fail by using "false".
  # The GREP command here checks for any tab characters in the the files
  # that match the specified pattern. GREP does not pick up explicit tabs
  # (e.g., literally a \t in a source file).
  # This grep command is invalid on osx.
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then if grep --recursive --include={*.cpp,*.c,*.h,*.md,*.yml,*.cmake.*.xml,*.html,*.in,*.txt} -P "\t" . ; then echo "Tabs found in the lines shown above. See CONTRIBUTING.md about tabs."; false; else echo "Repo passed no-tabs check."; fi; else echo "No-tabs check not performed."; fi
  
  ## Dependencies for Simbody.
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get update; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install liblapack-dev; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install freeglut3-dev libxi-dev libxmu-dev; fi
  - if $MPI; then sudo apt-get install mpich2; fi

  # C++11 on Ubuntu. Update to gcc 4.8, which provides full C++11 support.  We
  # use this script because if building Simbody with C++11, we need gcc-4.8,
  # and the Travis Ubuntu 12.04 machines have an older version of gcc. Even if
  # building with Clang, we need the newer libstdc++ that we get by updating to
  # gcc-4.8.  See https://github.com/travis-ci/travis-ci/issues/979.
  - if [[ "$TRAVIS_OS_NAME" = "linux" ]]; then sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y; fi
  - if [[ "$TRAVIS_OS_NAME" = "linux" ]]; then sudo apt-get update -qq; fi
  - if [[ "$TRAVIS_OS_NAME" = "linux" ]]; then sudo apt-get install -qq g++-4.8; fi
  - if [[ "$TRAVIS_OS_NAME" = "linux" && "$CXX" = "g++" ]]; then export CXX="g++-4.8" CC="gcc-4.8"; fi

install:
  - mkdir ~/simbody-build && cd ~/simbody-build
  # Configure.
  - cmake $TRAVIS_BUILD_DIR -DSIMBODY_MPI=$MPI -DCMAKE_CXX_FLAGS=-Werror
  # Build. If MPI, then only build CMAESTest.
  - if $MPI; then make --jobs=8 CMAESTest; fi
  - if ! $MPI; then make --jobs=8; fi

script:
  ## Test Simbody. If MPI, only test CMAESTest and CMAESMPITest.
  - if $MPI; then ctest --output-on-failure -R CMAES; fi
  - if ! $MPI; then ctest --parallel 8 --output-on-failure; fi
